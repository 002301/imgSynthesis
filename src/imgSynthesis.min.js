class imgSynthesis{constructor(w=640,h=1236,bg=""){this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.canvas.width=w;this.canvas.height=h;if(bg!=""){this.ctx.fillStyle=bg;this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}async addImgs(imgs){if(imgs!=null){for(let i of imgs){await this.addImg(...i)}}return this}async addTxts(txts){if(txts!=null){for(let i of txts){await this.addTxt(...i)}}return this}addTxt(text="文本",x=0,y=0,opts={}){return new Promise(res=>{this.setText();let{w:w=156,h:h=0,size:size="24px",color:color="#ffffff",writingMode:writingMode="",align:align="left"}=opts;this.ctx.font=size+"  Arial";this.ctx.textAlign=align;this.ctx.textBaseline="top";this.ctx.fillStyle=color;if(writingMode=="td"){this.ctx.fillTextVertical(String(text),x,y)}else{if(h==0){h=parseInt(size.replace(/px/,""))}this.ctx.wrapText(String(text),x,y,w,h)}res(this)})}addRect(w=10,h=10,x=0,y=0,color="#00ff00"){return new Promise(res=>{this.ctx.fillStyle=color;this.ctx.fillRect(x,y,w,h);res(this)})}addImg(src,x=0,y=0,opts={}){return new Promise((resolve,reject)=>{let img_bg=new Image;img_bg.setAttribute("crossOrigin","anonymous");if(src){img_bg.onload=(()=>{let{algin:algin="l"}=opts;if(algin=="r"){x=x-img_bg.width}if(opts.w){this.ctx.drawImage(img_bg,x,y,opts.w,opts.h)}else{this.ctx.drawImage(img_bg,x,y)}resolve(this)});img_bg.src=src}else{reject("缺少src参数")}})}getImg(str=""){if(str!=""){return this.canvas.toDataURL(str)}else{return this.canvas.toDataURL()}}setText(){CanvasRenderingContext2D.prototype.wrapText=function(text,x,y,maxWidth,lineHeight){if(typeof text!="string"||typeof x!="number"||typeof y!="number"){return}const context=this;const canvas=context.canvas;if(typeof maxWidth=="undefined"){maxWidth=canvas&&canvas.width||300}if(typeof lineHeight=="undefined"){lineHeight=canvas&&parseInt(window.getComputedStyle(canvas).lineHeight)||parseInt(window.getComputedStyle(document.body).lineHeight)}let arrText=text.split("");let line="";for(let n=0;n<arrText.length;n++){const testLine=line+arrText[n];const metrics=context.measureText(testLine);const testWidth=metrics.width;if(testWidth>maxWidth&&n>0){context.fillText(line,x,y);line=arrText[n];y+=lineHeight}else{line=testLine}}context.fillText(line,x,y)};CanvasRenderingContext2D.prototype.fillTextVertical=function(text,x,y){let context=this;let canvas=context.canvas;let arrText=text.split("");let arrWidth=arrText.map(function(letter){return context.measureText(letter).width});let align=context.textAlign;let baseline=context.textBaseline;if(align=="left"){x=x+Math.max.apply(null,arrWidth)/2}else if(align=="right"){x=x-Math.max.apply(null,arrWidth)/2}if(baseline=="bottom"||baseline=="alphabetic"||baseline=="ideographic"){y=y-arrWidth[0]/2}else if(baseline=="top"||baseline=="hanging"){y=y+arrWidth[0]/2}context.textAlign="center";context.textBaseline="middle";arrText.forEach(function(letter,index){let letterWidth=arrWidth[index];let code=letter.charCodeAt(0);if(code<=256){context.translate(x,y);context.rotate(90*Math.PI/180);context.translate(-x,-y)}else if(index>0&&text.charCodeAt(index-1)<256){y=y+arrWidth[index-1]/2}context.fillText(letter,x,y);context.setTransform(1,0,0,1,0,0);let letterWidth2=arrWidth[index];y=y+letterWidth2});context.textAlign=align;context.textBaseline=baseline}}}export default imgSynthesis;